{% extends "base.html" %}

{% block content %}
<div class="container mt-5 pt-4">
    <!-- Page Header -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="text-center">
                <h1 class="display-4 fw-bold mb-3">Solicitar Cotización</h1>
                <p class="lead text-muted">Cuéntanos sobre tu proyecto y te enviaremos una cotización personalizada</p>
            </div>
        </div>
    </div>

    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow">
                <div class="card-body p-5">
                    <form method="POST" action="{{ url_for('cotizacion') }}" id="quoteForm">
                        <div class="row g-3">
                            <!-- Personal Information -->
                            <div class="col-12">
                                <h5 class="border-bottom pb-2 mb-3">Información Personal</h5>
                            </div>
                            
                            <div class="col-md-6">
                                <label for="nombre" class="form-label">Nombre Completo <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="nombre" name="nombre" required>
                            </div>
                            
                            <div class="col-md-6">
                                <label for="email" class="form-label">Email <span class="text-danger">*</span></label>
                                <input type="email" class="form-control" id="email" name="email" required>
                            </div>
                            
                            <div class="col-md-6">
                                <label for="telefono" class="form-label">Teléfono</label>
                                <input type="tel" class="form-control" id="telefono" name="telefono">
                            </div>
                            
                            <div class="col-md-6">
                                <label for="empresa" class="form-label">Empresa</label>
                                <input type="text" class="form-control" id="empresa" name="empresa">
                            </div>

                            <!-- Project Information -->
                            <div class="col-12 mt-4">
                                <h5 class="border-bottom pb-2 mb-3">Información del Proyecto</h5>
                            </div>
                            
                            <div class="col-md-6">
                                <label for="categoria_id" class="form-label">Categoría de Servicio</label>
                                <select class="form-select" id="categoria_id" name="categoria_id">
                                    <option value="">Selecciona una categoría</option>
                                    {% for category in categories %}
                                    <option value="{{ category.id }}">{{ category.nombre }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            
                            <div class="col-md-6">
                                <label for="servicio_id" class="form-label">Servicio Específico</label>
                                <select class="form-select" id="servicio_id" name="servicio_id" disabled>
                                    <option value="">Primero selecciona una categoría</option>
                                </select>
                            </div>
                            
                            <div class="col-12">
                                <label for="mensaje" class="form-label">Descripción del Proyecto <span class="text-danger">*</span></label>
                                <textarea class="form-control" id="mensaje" name="mensaje" rows="5" 
                                          placeholder="Describe tu proyecto, objetivos, requerimientos específicos, etc." required></textarea>
                                <div class="form-text">Proporciona todos los detalles que consideres importantes para tu cotización.</div>
                            </div>

                            <!-- Budget and Timeline -->
                            <div class="col-12 mt-4">
                                <h5 class="border-bottom pb-2 mb-3">Presupuesto y Cronograma</h5>
                            </div>
                            
                            <div class="col-md-6">
                                <label for="presupuesto" class="form-label">Presupuesto Estimado</label>
                                <select class="form-select" id="presupuesto" name="presupuesto">
                                    <option value="">Selecciona un rango</option>
                                    <option value="menos-5k">Menos de $5,000</option>
                                    <option value="5k-10k">$5,000 - $10,000</option>
                                    <option value="10k-25k">$10,000 - $25,000</option>
                                    <option value="25k-50k">$25,000 - $50,000</option>
                                    <option value="50k-100k">$50,000 - $100,000</option>
                                    <option value="mas-100k">Más de $100,000</option>
                                    <option value="por-definir">Por definir</option>
                                </select>
                            </div>
                            
                            <div class="col-md-6">
                                <label for="fecha_limite" class="form-label">Fecha Límite Deseada</label>
                                <input type="date" class="form-control" id="fecha_limite" name="fecha_limite">
                            </div>

                            <!-- Submit -->
                            <div class="col-12 mt-4">
                                <div class="d-grid">
                                    <button type="submit" class="btn btn-primary btn-lg">
                                        <i class="fas fa-paper-plane me-2"></i>Enviar Solicitud de Cotización
                                    </button>
                                </div>
                                <div class="text-center mt-3">
                                    <small class="text-muted">
                                        Te responderemos dentro de 24-48 horas hábiles
                                    </small>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Sidebar with additional info -->
        <div class="col-lg-4">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">¿Por qué elegirnos?</h5>
                    <ul class="list-unstyled">
                        <li class="mb-2">
                            <i class="fas fa-check text-success me-2"></i>
                            Respuesta rápida (24-48 horas)
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-check text-success me-2"></i>
                            Cotización sin compromiso
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-check text-success me-2"></i>
                            Soluciones personalizadas
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-check text-success me-2"></i>
                            Tecnología de vanguardia
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-check text-success me-2"></i>
                            Soporte especializado
                        </li>
                    </ul>
                </div>
            </div>

            <div class="card mt-4">
                <div class="card-body">
                    <h5 class="card-title">Contacto Directo</h5>
                    <p class="card-text text-muted">¿Prefieres hablar directamente?</p>
                    
                    {% if company_phone %}
                    <div class="mb-2">
                        <i class="fas fa-phone text-primary me-2"></i>
                        <a href="tel:{{ company_phone }}" class="text-decoration-none">{{ company_phone }}</a>
                    </div>
                    {% endif %}
                    
                    {% if company_email %}
                    <div class="mb-3">
                        <i class="fas fa-envelope text-primary me-2"></i>
                        <a href="mailto:{{ company_email }}" class="text-decoration-none">{{ company_email }}</a>
                    </div>
                    {% endif %}
                    
                    <a href="{{ url_for('contacto') }}" class="btn btn-outline-primary w-100">
                        <i class="fas fa-envelope me-2"></i>Formulario de Contacto
                    </a>
                </div>
            </div>

            <div class="card mt-4 bg-light">
                <div class="card-body">
                    <h6 class="card-title">Proceso de Cotización</h6>
                    <div class="timeline">
                        <div class="timeline-item">
                            <div class="timeline-marker bg-primary"></div>
                            <div class="timeline-content">
                                <h6 class="mb-1">1. Solicitud</h6>
                                <small class="text-muted">Completas el formulario</small>
                            </div>
                        </div>
                        <div class="timeline-item">
                            <div class="timeline-marker bg-primary"></div>
                            <div class="timeline-content">
                                <h6 class="mb-1">2. Análisis</h6>
                                <small class="text-muted">Revisamos tu proyecto</small>
                            </div>
                        </div>
                        <div class="timeline-item">
                            <div class="timeline-marker bg-primary"></div>
                            <div class="timeline-content">
                                <h6 class="mb-1">3. Propuesta</h6>
                                <small class="text-muted">Te enviamos la cotización</small>
                            </div>
                        </div>
                        <div class="timeline-item">
                            <div class="timeline-marker bg-success"></div>
                            <div class="timeline-content">
                                <h6 class="mb-1">4. ¡Comenzamos!</h6>
                                <small class="text-muted">Iniciamos tu proyecto</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const categoriaSelect = document.getElementById('categoria_id');
    const servicioSelect = document.getElementById('servicio_id');
    
    // Handle category change to load services
    categoriaSelect.addEventListener('change', function() {
        const categoriaId = this.value;
        
        // Reset service select
        servicioSelect.innerHTML = '<option value="">Cargando servicios...</option>';
        servicioSelect.disabled = true;
        
        if (categoriaId) {
            // Fetch services for the selected category
            fetch(`/api/servicios/${categoriaId}`)
                .then(response => response.json())
                .then(data => {
                    servicioSelect.innerHTML = '<option value="">Selecciona un servicio (opcional)</option>';
                    
                    data.forEach(service => {
                        const option = document.createElement('option');
                        option.value = service.id;
                        option.textContent = service.nombre;
                        servicioSelect.appendChild(option);
                    });
                    
                    servicioSelect.disabled = false;
                })
                .catch(error => {
                    console.error('Error loading services:', error);
                    servicioSelect.innerHTML = '<option value="">Error cargando servicios</option>';
                });
        } else {
            servicioSelect.innerHTML = '<option value="">Primero selecciona una categoría</option>';
            servicioSelect.disabled = true;
        }
    });

    // Pre-select service if coming from URL parameter
    const urlParams = new URLSearchParams(window.location.search);
    const servicioParam = urlParams.get('servicio');
    
    if (servicioParam) {
        // We need to find which category this service belongs to
        // This would require additional logic or API call
        // For now, we'll just note the service ID
        window.preselectedService = servicioParam;
    }

    // Form validation
    const form = document.getElementById('quoteForm');
    form.addEventListener('submit', function(e) {
        const nombre = document.getElementById('nombre').value.trim();
        const email = document.getElementById('email').value.trim();
        const mensaje = document.getElementById('mensaje').value.trim();
        
        if (!nombre || !email || !mensaje) {
            e.preventDefault();
            alert('Por favor complete todos los campos requeridos.');
            return false;
        }
        
        // Simple email validation
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
            e.preventDefault();
            alert('Por favor ingrese un email válido.');
            return false;
        }
        
        // Show loading state
        const submitBtn = form.querySelector('button[type="submit"]');
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Enviando...';
    });
});
</script>

<style>
.timeline {
    position: relative;
    padding-left: 30px;
}

.timeline::before {
    content: '';
    position: absolute;
    left: 15px;
    top: 0;
    bottom: 0;
    width: 2px;
    background: #dee2e6;
}

.timeline-item {
    position: relative;
    margin-bottom: 20px;
}

.timeline-marker {
    position: absolute;
    left: -22px;
    top: 5px;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    border: 2px solid white;
    box-shadow: 0 0 0 2px #dee2e6;
}

.timeline-content {
    padding-left: 15px;
}
</style>
{% endblock %}